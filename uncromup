#!/bin/bash

# == Richiesta di password di root ==
echo -e "\e[1;32mRichiesta di password di root o amministratore (se non gi√† inserita in precedenza):\e[0m"
sudo echo -e "\e[1;32mPassword inserita correttamente!\e[0m"
sleep 1

# == Chiusura di Cromite se aperto ==
sudo echo -e "\e[1;32mChiusura del Browser Cromite...\e[0m"
sudo pkill -9 cromite
sleep 1

# == Inizio disinstallazione Cromite ==
sudo echo -e "\e[1;32mRimozione cartella ~/Cromite...\e[0m"
sleep 1
sudo rm -fr ~/Cromite
sudo echo -e "\e[1;32mRimozione icona e collegamenti nel menu start...\e[0m"
sleep 1
sudo rm -fr /usr/share/icons/hicolor/192x192/apps/cromite.png
sleep 1
sudo rm -fr /usr/share/icons/hicolor/192x192/apps/cromite
sleep 1
sudo rm -fr /usr/local/bin/cromup
sleep 1
sudo rm -fr ~/.local/share/applications/Cromite.desktop
sleep 1
sudo rm -fr /usr/share/applications/Cromite.desktop
sleep 1

# ============================================
# == AGGIORNAMENTO CACHE KDE ==
# ============================================
if [[ "${XDG_CURRENT_DESKTOP:-}" == *"KDE"* ]] || [[ "${DESKTOP_SESSION:-}" == *"plasma"* ]]; then
  echo "üîÑ Sistema KDE rilevato, aggiorno cache..."
  
  # Rimuovi override KDE se esistono
  rm -f "$HOME/.config/menus/applications-kmenuedit.menu" 2>/dev/null
  rm -rf "$HOME/.cache/"*plasma* 2>/dev/null
  rm -f "$HOME/.cache/kactivitymanager-statsrc" 2>/dev/null
  
  # Aggiorna cache icone
  echo "üîÑ Aggiornamento cache icone..."
  sudo gtk-update-icon-cache /usr/share/icons/hicolor 2>/dev/null
  sleep 1
  
  # Ricostruisci cache KDE
  echo "üîÑ Ricostruzione cache SYCOCA..."
  kbuildsycoca6 --noincremental 2>/dev/null
  sleep 2
  
  # Aggiorna database desktop files
  update-desktop-database "$HOME/.local/share/applications" 2>/dev/null
  sleep 1
  
  # Ricostruisci nuovamente cache SYCOCA per sicurezza
  echo "üîÑ Seconda ricostruzione cache SYCOCA..."
  kbuildsycoca6 --noincremental 2>/dev/null
  sleep 2
  
  # Riavvia Plasmashell solo se √® in esecuzione
  if pgrep -x plasmashell > /dev/null; then
    echo "üîÑ Riavvio Plasmashell..."
    killall plasmashell 2>/dev/null
    sleep 2
    nohup plasmashell > /dev/null 2>&1 &
    sleep 3
  fi
  
  echo "‚úÖ Cache KDE aggiornata."
  sleep 1
else
  echo "‚ÑπÔ∏è  Sistema non-KDE, aggiorno solo cache icone..."
  sudo gtk-update-icon-cache /usr/share/icons/hicolor 2>/dev/null || true
fi

# == Fine disinstallazione Cromite Browser ==
sudo echo -e "\e[1;32mCromite Browser rimosso dal sistema. Fra pochi secondi lo script terminer√†.\e[0m"
sudo rm -fr /usr/local/bin/uncromup
sleep 3
