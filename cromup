#!/bin/bash

# ============================================
# == DEFINIZIONE VARIABILI ==
# ============================================
APP_NAME="Cromite"
DOWNLOAD_DIR="$HOME"
CROMITE_DIR="$HOME/Cromite"

# URL Downloads
FILE_URL="https://github.com/uazo/cromite/releases/latest/download/chrome-lin64.tar.gz"
# FILE_URL="https://github.com/uazo/cromite/releases/download/Fix-2326/chrome-lin64.tar.gz"  # Download temporaneo per bugs
ICON_URL="https://raw.githubusercontent.com/RootGPT-YouTube/rootgpt-Cromup/refs/heads/main/cromite_icon.png"
CROMUP_URL="https://raw.githubusercontent.com/RootGPT-YouTube/rootgpt-Cromup/refs/heads/main/cromup"
UNCROMUP_URL="https://raw.githubusercontent.com/RootGPT-YouTube/rootgpt-Cromup/refs/heads/main/uncromup"

# File e percorsi
FILE_NAME="chrome-lin64.tar.gz"
ICON_NAME_PATH="$HOME/Cromite/cromite_icon.png"
ICON_DEST1="/usr/share/icons/hicolor/192x192/apps/cromite.png"
ICON_DEST2="/usr/share/icons/hicolor/192x192/apps/cromite"
CROMUP_PATH="/usr/local/bin/cromup"
CROMUP_TEMP="$CROMITE_DIR/cromup.new"
UNCROMUP_PATH="/usr/local/bin/uncromup"
UNCROMUP_DIR="$HOME/Cromite/uncromup"
VERSION_FILE="$CROMITE_DIR/.cromite_version"

# Desktop e menu
KDE_MENU="$HOME/.config/menus/applications-kmenuedit.menu $HOME/.cache/*plasma* $HOME/.cache/kactivitymanager-statsrc $HOME/.local/share/applications/Cromite.desktop"
DESKTOP_LOCAL="$HOME/.local/share/applications/${APP_NAME}.desktop"

# ============================================
# == STEMMA ==
# ============================================
echo -e "${GREEN}"
echo "**************************************"
echo "*                                    *"
echo "*       Cromup 2.0 by RâˆžtGPT         *"
echo "*       Cromite by Uazo              *"
echo "*                                    *"
echo "**************************************"
echo -e "${RESET}"

# ============================================
# == CONTROLLO VERSIONE ==
# ============================================
echo -e "\e[1;32mControllo versione di Cromite...\e[0m"
sleep 2

# Recupera il tag dell'ultima release da GitHub API
remote_version=$(curl -s https://api.github.com/repos/uazo/cromite/releases/latest | grep '"tag_name":' | sed -E 's/.*"tag_name": "([^"]+)".*/\1/')

# Verifica che il tag sia stato recuperato correttamente
if [ -z "$remote_version" ]; then
    echo -e "\e[1;33mAttenzione: impossibile recuperare la versione remota. Procedo con l'aggiornamento per sicurezza.\e[0m"
    local_version=""
else
    if [ -f "$VERSION_FILE" ]; then
        local_version=$(cat "$VERSION_FILE")
    else
        echo -e "\e[1;33mFile di versione non trovato, procedo con installazione completa.\e[0m"
        local_version=""
    fi
fi

# ============================================
# == VERIFICA SE AGGIORNAMENTO NECESSARIO ==
# ============================================
if [ -n "$remote_version" ] && [ "$remote_version" = "$local_version" ]; then
    echo -e "\e[1;32mCromite Ã¨ giÃ  aggiornato (Versione: $remote_version). Proseguo con altre verifiche...\e[0m"
    
    # == Installazione di uncromup in caso di Cromite giÃ  aggiornato ==
    echo -e "\e[1;32mVerifica di aggiornamenti di uncromup online...\e[0m"
    sleep 3
    curl -fL --progress-bar -o "$UNCROMUP_DIR" "$UNCROMUP_URL" || { echo -e "\e[1;32mErrore nel download dell'aggiornamento di uncromup!\e[0m"; exit 1; }
    sudo cp "$UNCROMUP_DIR" "$UNCROMUP_PATH"
    sudo chmod a+x "$UNCROMUP_PATH"

    # == Auto-aggiornamento cromup ==
    echo -e "\e[1;32mVerifica aggiornamenti di cromup online...\e[0m"
    sleep 2
    
    if curl -fL --progress-bar -o "$CROMUP_TEMP" "$CROMUP_URL" 2>/dev/null; then
        # Crea uno script temporaneo che sostituirÃ  cromup DOPO che questo script termina
        cat > "$CROMITE_DIR/.update_cromup.sh" << 'UPDATER'
#!/bin/bash
sleep 1
sudo cp "$1" "$2"
sudo chmod a+x "$2"
rm -f "$1" "$0"
UPDATER
        
        chmod a+x "$CROMITE_DIR/.update_cromup.sh"
        
        # Lancia l'aggiornamento in background e termina immediatamente questo script
        nohup "$CROMITE_DIR/.update_cromup.sh" "$CROMUP_TEMP" "$CROMUP_PATH" > /dev/null 2>&1 &
        
        echo -e "\e[1;32mAggiornamento di cromup completato!\e[0m"
    else
        echo -e "\e[1;33mImpossibile verificare aggiornamenti di cromup.\e[0m"
    fi
    
    sleep 2
    echo -e "\e[1;32mâœ… Verifica completata!\e[0m"
    exit 0
fi

echo -e "\e[1;33mNuova versione disponibile: $remote_version (Attuale: ${local_version:-nessuna}). Procedo con l'aggiornamento...\e[0m"
sleep 2

# ============================================
# == RICHIESTA PASSWORD ROOT ==
# ============================================
echo -e "\e[1;32mRichiesta di password di root o amministratore (se non giÃ  inserita in precedenza):\e[0m"
sudo echo -e "\e[1;32mPassword inserita correttamente!\e[0m"

# ============================================
# == INSTALLAZIONE DIPENDENZE ==
# ============================================
# == Installazione di pkill (se non presente) ==
echo -e "\e[1;32mVerifica ed eventuale installazione delle dipendenze: software pkill...\e[0m"
if ! command -v pkill &> /dev/null; then
    echo -e "\e[1;32mpkill non trovato, installazione in corso...\e[0m"
    if command -v dnf &> /dev/null; then
        sudo dnf install procps-ng -y
    elif command -v apt &> /dev/null; then
        sudo apt install procps -y
    elif command -v pacman &> /dev/null; then
        sudo pacman -Syu --noconfirm procps-ng
    elif command -v zypper &> /dev/null; then
        sudo zypper install procps -y
    else
        echo -e "\e[1;32mImpossibile installare pkill automaticamente, Ã¨ necessario installarlo manualmente.\e[0m"
        exit 1
    fi
fi

# == Installazione di pv (se non presente) ==
echo -e "\e[1;32mVerifica ed eventuale installazione delle dipendenze: software pv...\e[0m"
if ! command -v pv &> /dev/null; then
    echo -e "\e[1;32mpv non trovato, installazione in corso...\e[0m"
    if command -v dnf &> /dev/null; then
        sudo dnf install pv -y
    elif command -v apt &> /dev/null; then
        sudo apt install pv -y
    elif command -v pacman &> /dev/null; then
        sudo pacman -Syu --noconfirm pv
    elif command -v zypper &> /dev/null; then
        sudo zypper install pv -y
    else
        echo -e "\e[1;32mImpossibile installare pv automaticamente, Ã¨ necessario installarlo manualmente.\e[0m"
        exit 1
    fi
fi

# ============================================
# == CHIUSURA CROMITE ==
# ============================================
sudo pkill -9 cromite
sleep 1

# ============================================
# == DOWNLOAD CROMITE ==
# ============================================
echo -e "\e[1;32mDownload del file archivio di Cromite...\e[0m"
mkdir -p "$DOWNLOAD_DIR"
curl -L --progress-bar -o "$DOWNLOAD_DIR/$FILE_NAME" "$FILE_URL" || { echo -e "\e[1;32mErrore nel download di Cromite!\e[0m"; exit 1; }

# ============================================
# == PREPARAZIONE DIRECTORY ==
# ============================================
mkdir -p "$CROMITE_DIR"

# == Elimina i file .manifest nelle sottocartelle di Cromite ==
echo -e "\e[1;32mPulizia dei files .manifest delle vecchie versioni...\e[0m"
sleep 3
find "$CROMITE_DIR" -type f -name "*.manifest" -exec rm -f {} +

# ============================================
# == DOWNLOAD E INSTALLAZIONE ICONA ==
# ============================================
echo -e "\e[1;32mDownload icona personalizzata di Cromite...\e[0m"
sleep 2
curl -fL --progress-bar -o "$ICON_NAME_PATH" "$ICON_URL" || { echo -e "\e[1;32mErrore nel download dell'icona!\e[0m"; exit 1; }
sudo cp "$ICON_NAME_PATH" "$ICON_DEST1"
sudo cp "$ICON_NAME_PATH" "$ICON_DEST2"

# ============================================
# == ESTRAZIONE ARCHIVIO ==
# ============================================
echo -e "\e[1;32mEstrazione del file archivio di Cromite...\e[0m"
pv -p -e -L 50000000 -s "$(stat -c%s "$DOWNLOAD_DIR/$FILE_NAME")" "$DOWNLOAD_DIR/$FILE_NAME" | tar -xz -f - -C "$CROMITE_DIR" --overwrite || { echo -e "\e[1;32mErrore nell'estrazione!\e[0m"; exit 1; }

# ============================================
# == INSTALLAZIONE E PULIZIA ==
# ============================================
echo -e "\e[1;32mInstallazione dei nuovi files di Cromite e pulizia dei files ridondanti...\e[0m"
sleep 3
cp -r "$CROMITE_DIR/chrome-lin/"* "$CROMITE_DIR/"
rm -rf "$CROMITE_DIR/chrome-lin"
rm "$DOWNLOAD_DIR/$FILE_NAME"
cp "$CROMITE_DIR/chrome" "$CROMITE_DIR/cromite"
rm "$CROMITE_DIR/chrome"

# ============================================
# == SALVATAGGIO VERSIONE ==
# ============================================
if [ -n "$remote_version" ]; then
    echo "$remote_version" > "$VERSION_FILE"
    echo -e "\e[1;32mVersione installata salvata (Tag: $remote_version)\e[0m"
fi

# ============================================
# == CREAZIONE COLLEGAMENTO DESKTOP ==
# ============================================
echo -e "\e[1;32mCreazione collegamento nel menu applicazioni...\e[0m"
mkdir -p "$HOME/.local/share/applications"

cat > "$DESKTOP_LOCAL" << EOF
[Desktop Entry]
Version=1.0
Name=Cromite
Comment=Cromite Web Browser
Exec=$CROMITE_DIR/cromite
Terminal=false
Type=Application
Icon=cromite
Categories=Network;WebBrowser;
MimeType=text/html;text/xml;application/xhtml+xml;x-scheme-handler/http;x-scheme-handler/https;
StartupNotify=true
EOF

chmod a+x "$DESKTOP_LOCAL"
echo -e "\e[1;32mCollegamento creato in: $DESKTOP_LOCAL\e[0m"

# ============================================
# == AGGIORNAMENTO CACHE KDE ==
# ============================================
if [[ "${XDG_CURRENT_DESKTOP:-}" == *"KDE"* ]] || [[ "${DESKTOP_SESSION:-}" == *"plasma"* ]]; then
  echo "ðŸ”„ Sistema KDE rilevato, aggiorno cache..."
  
  # Rimuovi override KDE se esistono
  rm -f "$HOME/.config/menus/applications-kmenuedit.menu" 2>/dev/null
  rm -rf "$HOME/.cache/"*plasma* 2>/dev/null
  rm -f "$HOME/.cache/kactivitymanager-statsrc" 2>/dev/null
  
  # Aggiorna cache icone
  echo "ðŸ”„ Aggiornamento cache icone..."
  sudo gtk-update-icon-cache /usr/share/icons/hicolor 2>/dev/null
  sleep 1
  
  # Ricostruisci cache KDE
  echo "ðŸ”„ Ricostruzione cache SYCOCA..."
  kbuildsycoca6 --noincremental 2>/dev/null
  sleep 2
  
  # Aggiorna database desktop files
  update-desktop-database "$HOME/.local/share/applications" 2>/dev/null
  sleep 1
  
  # Ricostruisci nuovamente cache SYCOCA per sicurezza
  echo "ðŸ”„ Seconda ricostruzione cache SYCOCA..."
  kbuildsycoca6 --noincremental 2>/dev/null
  sleep 2
  
  # Riavvia Plasmashell solo se Ã¨ in esecuzione
  if pgrep -x plasmashell > /dev/null; then
    echo "ðŸ”„ Riavvio Plasmashell..."
    killall plasmashell 2>/dev/null
    sleep 2
    nohup plasmashell > /dev/null 2>&1 &
    sleep 3
  fi
  
  echo "âœ… Cache KDE aggiornata."
  sleep 1
else
  echo "â„¹ï¸  Sistema non-KDE, aggiorno solo cache icone..."
  sudo gtk-update-icon-cache /usr/share/icons/hicolor 2>/dev/null || true
fi

# ============================================
# == IGNORA ERRORI DA QUI ==
# ============================================
exec 2>/dev/null

# ============================================
# == INSTALLAZIONE UNCROMUP ==
# ============================================
echo -e "\e[1;32mVerifica di aggiornamenti di uncromup online...\e[0m"
sleep 3
curl -fL --progress-bar -o "$UNCROMUP_DIR" "$UNCROMUP_URL" || { echo -e "\e[1;32mErrore nel download dell'aggiornamento di uncromup!\e[0m"; exit 1; }
sudo cp "$UNCROMUP_DIR" "$UNCROMUP_PATH"
sudo chmod a+x "$UNCROMUP_PATH"

# ============================================
# == AUTO-AGGIORNAMENTO CROMUP ==
# ============================================
echo -e "\e[1;32mVerifica aggiornamenti di cromup online...\e[0m"
sleep 2

if curl -fL --progress-bar -o "$CROMUP_TEMP" "$CROMUP_URL" 2>/dev/null; then
    # Crea uno script temporaneo che sostituirÃ  cromup DOPO che questo script termina
    cat > "$CROMITE_DIR/.update_cromup.sh" << 'UPDATER'
#!/bin/bash
sleep 1
sudo cp "$1" "$2"
sudo chmod a+x "$2"
rm -f "$1" "$0"
UPDATER
    
    chmod a+x "$CROMITE_DIR/.update_cromup.sh"
    
    # Lancia l'aggiornamento in background e termina immediatamente questo script
    nohup "$CROMITE_DIR/.update_cromup.sh" "$CROMUP_TEMP" "$CROMUP_PATH" > /dev/null 2>&1 &
    
    echo -e "\e[1;32mAggiornamento di cromup completato!\e[0m"
else
    echo -e "\e[1;33mImpossibile verificare aggiornamenti di cromup.\e[0m"
fi

sleep 2
echo -e "\e[1;32mâœ… Rimozione cartella di lavoro...\e[0m"
sudo rm -fr "$HOME/rootgpt-Cromup"
echo -e "\e[1;32mâœ… Installazione completata con successo!\e[0m"
exit 0
